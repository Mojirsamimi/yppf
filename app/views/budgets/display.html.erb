<h1 id = "h1ex">Budget for <%= @get_month_year%></h1>

<p id="notice">
	<%= notice %>
</p>

<br>

<% @expense_categories = ExpenseCategory.all %>
<% @expense_categories.each_slice(2) do |categories1, categories2| %>
<% value1 = get_percentage(categories1) %>
<% value2 = get_percentage(categories2) %>
<div class="container-fluid">
	<div class="row">
		<% if value1 > 0 %>
		<div class="col-md-5">
			<div class="row">
				<div class="col-xs-1 text-left nopad">
					$0
				</div>



				<div class="col-xs-10 text-center nopad">
					<a role="button" data-toggle="collapse" href="#collapse-<%= categories1.id%>" aria-expanded="false" aria-controls="collapseExample"> <%= "#{categories1.exp_name}" %></a>
				</div>


				<div class="col-xs-1 text-right nopad">
					$<%= "#{get_sumProj(categories1)}" %>
				</div>
			</div>
			<div class="row">

				<div class="bar-wrap">
					<div class="progress">
						<div id="progress-bar-cat-<%=categories1.id%>" class="progress-bar <%= get_progress_type(value1 * 100) %>" role="progressbar" aria-valuenow="<%= get_sumAct(categories1)%>" aria-valuemin="0" aria-valuemax="<%= get_sumProj(categories1) %>" style="width: <%= value1 * 100 %>%"></div>

					</div>

					<div style="left:0%" class="progress-marker"></div>
					<div style="right:0%" class="progress-marker"></div>

				</div>

			</div>
			<div class="row">
				<div class="collapse" id="collapse-<%= categories1.id%>">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title"><%= categories1.exp_name%> Details</h3>
						</div>
						<div class="panel-body">

							<%expenses_by_category(categories1.id).each do |expense|%>
							<div class="row">
								<div class="col-md-1 text-left">
									$0
								</div>
								<div class="col-md-8 text-center nopad">
									<%= expense.expensename%>
								</div>
								<div class="col-md-1 text-right nopad">
									$<%= expense.projvalue %>
								</div>
								<div class="col-md-2 text-right"></div>
							</div>
							<div class="row">

								<div class="col-md-10" >
									<div class="bar-wrap">
										<div class="progress" id="mini">
											<div id="progress-bar-exp-<%=expense.id%>" class="progress-bar <%= get_progress_type((expense.actvalue/expense.projvalue) * 100) %> progress-bar-striped" role="progressbar" aria-valuenow="<%= expense.actvalue%>" aria-valuemin="0" aria-valuemax="<%= expense.projvalue %>" style="width: <%= (expense.actvalue/expense.projvalue) * 100 %>%">

											</div>

										</div>

										<div style="left:0%" class="progress-marker"></div>
										<div style="right:0%" class="progress-marker"></div>

									</div>
								</div>
								<div class="col-md-2 nopad">
									<a  data-toggle="modal" data-expname="<%= expense.expensename%>" data-url="<%= "/expenses/#{expense.id}/expense_details/new"%>" href="#ExpenseDetailModal" aria-hidden="true"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>

								</div>
							</div>

							<%end%>

						</div>
					</div>
				</div>
			</div>
		</div>
		<%end%>

		<div class="col-md-2"></div>

		<% if value2 > 0 %>
		<div class="col-md-5">
            <div class="row">
                <div class="col-xs-1 text-left nopad">
                    $0
                </div>


                <div class="col-xs-10 text-center nopad">
                    <a role="button" data-toggle="collapse" href="#collapse-<%= categories2.id%>" aria-expanded="false" aria-controls="collapseExample"> <%= "#{categories2.exp_name}" %></a>
                </div>


                <div class="col-xs-1 text-right nopad">
                    $<%= get_sumProj(categories2) %>
                </div>
            </div>
            <div class="row">

                <div class="bar-wrap">
                    <div class="progress">
                        <div id="progress-bar-cat-<%=categories2.id%>" class="progress-bar <%= get_progress_type(value2 * 100) %>" role="progressbar" aria-valuenow="<%= get_sumAct(categories2)%>" aria-valuemin="0" aria-valuemax="<%= get_sumProj(categories2) %>" style="width: <%= value2 * 100 %>%"></div>

                    </div>

                    <div style="left:0%" class="progress-marker"></div>
                    <div style="right:0%" class="progress-marker"></div>

                </div>

            </div>
            <div class="row">
                <div class="collapse" id="collapse-<%= categories2.id%>">
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title"><%= categories2.exp_name%> Details</h3>
                      </div>
                      <div class="panel-body">

                            <%expenses_by_category(categories2.id).each do |expense|%>
                            <div class="row">
                                <div class="col-md-1 text-left">
                                    $0
                                </div>
                                <div class="col-md-8 text-center nopad">
                                    <%= expense.expensename%>
                                </div>
                                <div class="col-md-1 text-right nopad">
                                    $<%= expense.projvalue %>
                                </div>
                                <div class="col-md-2 text-right"></div>
                            </div>
                            <div class="row">

                                <div class="col-md-10" >
                                    <div class="bar-wrap">
                                        <div class="progress" id="mini">
                                            <div id="progress-bar-exp-<%=expense.id%>" class="progress-bar <%= get_progress_type((expense.actvalue/expense.projvalue) * 100) %> progress-bar-striped" role="progressbar" aria-valuenow="<%= expense.actvalue%>" aria-valuemin="0" aria-valuemax="<%= expense.projvalue %>" style="width: <%= (expense.actvalue/expense.projvalue) * 100 %>%">

                                            </div>

                                        </div>

                                        <div style="left:0%" class="progress-marker"></div>
                                        <div style="right:0%" class="progress-marker"></div>

                                    </div>
                                </div>
                                <div class="col-md-2 nopad">
                                    <a  data-toggle="modal" data-expname="<%= expense.expensename%>" data-url="<%= "/expenses/#{expense.id}/expense_details/new"%>" href="#ExpenseDetailModal" aria-hidden="true"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>

                                </div>
                            </div>

                            <%end%>

                        </div>

                </div>
            </div>
        </div>
      </div>
		<% end %>
	</div>
</div>

<% end %>

<!-- Total Expenditure details -->
<div class="col-md-12">
	<div class="row">
		<div class="col-xs-1 text-left nopad">
			$0
		</div>
		<div class="col-xs-10 text-center nopad">
			<%= get_total_expenditure_message(Date.today.month, Date.today.year) %>
		</div>
		<div class="col-xs-1 text-right nopad">
			$<%= "#{get_projvalue(Date.today.month, Date.today.year)}" %>
		</div>
	</div>
	<div class="row">
		<div class="bar-wrap">
			<div class="progress">
				<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="<%= get_actvalue(Date.today.month, Date.today.year)%>" aria-valuemin="0" aria-valuemax="<%= get_projvalue(Date.today.month, Date.today.year)%>" style="width: <%= get_total_expenditure(Date.today.month, Date.today.year)%>%"></div>
			</div>
			<div style="left:0%" class="progress-marker"></div>
			<div style="right:0%" class="progress-marker"></div>
		</div>
	</div>
</div>

<br>

<button type="button" class="btn btn-primary" onclick="window.location.href='<%= expense_references_path%>'">
	<span class="glyphicon glyphicon-cog" aria-hidden="true"></span> Manage Expenses
</button>
<br>

<center>
	<%= link_to 'Back to Dashboard', dashboard_new_path %>
</center>

<div class="modal fade" id="ExpenseDetailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" id="myModalLabel">Modal title</h4>
			</div>
			<div class="modal-body">
				<div id="expense-detail-form">

				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Close
				</button>
				<button type="button" id="save-transaction" class="btn btn-primary" data-dismiss="modal">
					Save changes
				</button>
			</div>
		</div>
	</div>
</div>




<!-- Trigger the modal with a button -->
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Test budget update</button>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Time to update your Budget for the month!</h4>
      </div>
      <div class="modal-body">




        <div class="row">
      		<div class="col-md-2 text-center nopad">
            <b> Category </b>
          </div>
          <div class="col-md-2 text-center nopad">
            <b> Suggestion </b>
          </div>
          <div class="col-md-2 text-center nopad">
            <b> General Value </b>
          </div>
          <div class="col-md-2 text-center nopad">
            <b> Detailed Value </b>
          </div>
          <div class="col-md-3 text-center nopad">
            <b> List Details </b>
          </div>
        </div>
        <% @expense_categories = ExpenseCategory.all %>
        <% @expense_categories.each do |categories| %>
        <div class="row">
      		<div class="col-md-2 text-center nopad">
            <%= categories.exp_name %>
          </div>
          <div class="col-md-2 text-center nopad">
            <%= get_sumProj(categories) %>
          </div>
          <div class="col-md-2 text-center nopad">
            <div class="col-md-9 text-center nopad">
              <input type="decimal">
            </div>
            <div class="col-md-3 text-center nopad">
              <%= link_to 'Add', '/expense_references/new' %>
            </div>
          </div>
          <div class="col-md-2 text-center nopad">
              <!-- <%= link_to 'Add', '/expense_references/new' %> -->
              <a  data-toggle="modal" href="#ExpenseReferenceModal" data-url="<%=expense_references_allinone_new_path%>" aria-hidden="true"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
              <!-- <a  data-toggle="modal" data-url="<%= "/expense_references/new2"%>" href="#ExpenseReferenceModal" aria-hidden="true"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a> -->
            </div>
          <div class="col-md-3 text-center">
            <a role="button" data-toggle="collapse" href="#collapse-2-<%= categories.id%>" aria-expanded="false" aria-controls="collapseExample"> <%= "#{categories.exp_name}" %></a>
            <div class="collapse" id="collapse-2-<%= categories.id%>">
                <div class="panel panel-default">
                  <div class="panel-body">

                        <%expenses_by_category(categories.id).each do |expense|%>
                        <div class="row">
                            <div class="col-md-8 nopad">
                              <script>
                              function myFunction() {
                              if('<%= expense.expensename %>' == ''){
                                document.write("General");
                              }
                              else{
                                document.write("<%= expense.expensename%>");
                              }}
                              </script>
                              <script>
                              window.myFunction();
                              </script>

                            </div>
                            <div class="col-md-1 text-right nopad">
                                $<%= expense.projvalue %>
                            </div>
                            <div class="col-md-2 text-right"></div>
                        </div>


                        <%end%>

                    </div>

            </div>
            </div>
          </div>


        </div>
        <% end %>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="ExpenseReferenceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" id="myModalLabel">Modal title</h4>
			</div>
			<div class="modal-body">
				<div id="allinone-expense-reference-form">


          <!-- This is where the expense-references form needs to be generated...somehow...with magic -->


				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Close
				</button>
				<button type="button" id="save-transaction" class="btn btn-primary" data-dismiss="modal">
					Save changes
				</button>
			</div>
		</div>
	</div>
</div>
<script>
	$('#ExpenseReferenceModal').on('show.bs.modal', function(event) {
		var button = $(event.relatedTarget)// Button that triggered the modal
		var expense_detail_url = button.data('url')// Extract info from data-* attributes
		// If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
		// Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
		var modal = $(this)
		modal.find('.modal-title').text('New transaction')
		$.ajax({
			url : expense_detail_url,
			type : "GET"
		});
	})

	$('#save-transaction').click(function() {

        $("#new_expense_reference").submit();

    })
</script>

<script>
    $('#ExpenseDetailModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget)// Button that triggered the modal
        var expense_detail_url = button.data('url')// Extract info from data-* attributes
        var expense_name = button.data('expname')
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this)
        modal.find('.modal-title').text('New transaction for ' + expense_name)
        $.ajax({
            url : expense_detail_url,
            type : "GET"
        });
    })

    $('#save-transaction').click(function() {

        $("#new_expense_detail").submit();

    })
</script>



<!-- Triggers the update budget modal on first of month, currently set to today's date -->
<script type="text/javascript">
    $(window).load(function(){
      if('<%= @get_day %>' == 27){
        $('#myModal').modal('show');
      }
    });
</script>

